<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstallMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">itf-maven-plugin</a> &gt; <a href="index.source.html" class="el_package">com.soebes.itf.maven.plugin</a> &gt; <span class="el_source">InstallMojo.java</span></div><h1>InstallMojo.java</h1><pre class="source lang-java linenums">package com.soebes.itf.maven.plugin;

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

import com.soebes.itf.jupiter.maven.ProjectHelper;
import org.apache.maven.artifact.Artifact;
import org.apache.maven.artifact.factory.ArtifactFactory;
import org.apache.maven.artifact.repository.ArtifactRepository;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.model.Model;
import org.apache.maven.model.Parent;
import org.apache.maven.plugin.AbstractMojo;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugins.annotations.Component;
import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.apache.maven.plugins.annotations.ResolutionScope;
import org.apache.maven.project.MavenProject;
import org.apache.maven.project.ProjectBuildingRequest;
import org.apache.maven.shared.transfer.artifact.install.ArtifactInstaller;
import org.apache.maven.shared.transfer.repository.RepositoryManager;
import org.codehaus.plexus.util.FileUtils;

import java.io.File;
import java.io.IOException;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.Map;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.stream.Collectors;

import static java.util.function.Function.identity;

/**
 * itf-maven-plugin.
 *
 * @author &lt;a href=&quot;mailto:khmarbaise@apache.org&quot;&gt;Karl Heinz Marbaise&lt;/a&gt;
 * @implNote Several parts are taken from the maven-invoker-plugin.
 */
@Mojo(name = &quot;install&quot;, defaultPhase = LifecyclePhase.PRE_INTEGRATION_TEST,
    requiresDependencyResolution = ResolutionScope.RUNTIME, threadSafe = true)
<span class="nc" id="L64">public class InstallMojo extends AbstractMojo {</span>
  @Parameter(defaultValue = &quot;${session}&quot;, required = true, readonly = true)
  private MavenSession session;

  @Parameter(defaultValue = &quot;${project}&quot;, required = true, readonly = true)
  private MavenProject project;

  /**
   * This defines the location where the installed artifacts are installed for
   * consumption during the integration tests.
   */
  @Parameter(defaultValue = &quot;${project.basedir}/target/itf-repo&quot;, required = true)
  private File itfRepository;

  @Component
  private RepositoryManager repositoryManager;

  @Component
  private ArtifactInstaller installer;

  /**
   * The set of Maven projects in the reactor build.
   */
  @Parameter(defaultValue = &quot;${reactorProjects}&quot;, readonly = true)
  private Collection&lt;MavenProject&gt; reactorProjects;

  /**
   * The identifiers of already installed artifacts, used to avoid multiple installation of the same artifact.
   */
  private Collection&lt;String&gt; installedArtifacts;

  /**
   * The identifiers of already copied artifacts, used to avoid multiple installation of the same artifact.
   */
  private Collection&lt;String&gt; copiedArtifacts;

  /**
   * The component used to create artifacts.
   */
  @Component
  private ArtifactFactory artifactFactory;

  /**
   *
   */
  @Parameter(property = &quot;localRepository&quot;, required = true, readonly = true)
  private ArtifactRepository localRepository;

  private ProjectBuildingRequest projectBuildingRequest;

  public void execute() throws MojoExecutionException, MojoFailureException {
<span class="nc" id="L115">    createTestRepository();</span>

<span class="nc" id="L117">    installedArtifacts = new HashSet&lt;&gt;();</span>
<span class="nc" id="L118">    copiedArtifacts = new HashSet&lt;&gt;();</span>

<span class="nc" id="L120">    installProjectDependencies(project, reactorProjects);</span>
<span class="nc" id="L121">    installProjectParents(project);</span>
<span class="nc" id="L122">    installProjectArtifacts(project);</span>

    //TODO: We should consider to implement this?
//        installExtraArtifacts( extraArtifacts );

<span class="nc" id="L127">  }</span>


  private void createTestRepository()
      throws MojoExecutionException {

<span class="nc bnc" id="L133" title="All 4 branches missed.">    if (!itfRepository.exists() &amp;&amp; !itfRepository.mkdirs()) {</span>
<span class="nc" id="L134">      throw new MojoExecutionException(&quot;Failed to create directory: &quot; + itfRepository);</span>
    }
<span class="nc" id="L136">    projectBuildingRequest =</span>
<span class="nc" id="L137">        repositoryManager.setLocalRepositoryBasedir(session.getProjectBuildingRequest(), itfRepository);</span>
<span class="nc" id="L138">  }</span>

  /**
   * Installs the specified artifact to the local repository. Note: This method should only be used for artifacts that
   * originate from the current (reactor) build. Artifacts that have been grabbed from the user's local repository
   * should be installed to the test repository via {@link #copyArtifact(File, Artifact)}.
   *
   * @param file The file associated with the artifact, must not be &lt;code&gt;null&lt;/code&gt;. This is in most cases the value
   * of &lt;code&gt;artifact.getFile()&lt;/code&gt; with the exception of the main artifact from a project with
   * packaging &quot;pom&quot;. Projects with packaging &quot;pom&quot; have no main artifact file. They have however artifact
   * metadata (e.g. site descriptors) which needs to be installed.
   * @param artifact The artifact to install, must not be &lt;code&gt;null&lt;/code&gt;.
   * @throws MojoExecutionException If the artifact could not be installed (e.g. has no associated file).
   */
  private void installArtifact(File file, Artifact artifact)
      throws MojoExecutionException {
    try {
<span class="nc bnc" id="L155" title="All 2 branches missed.">      if (file == null) {</span>
<span class="nc" id="L156">        throw new IllegalStateException(&quot;Artifact has no associated file: &quot; + artifact.getId());</span>
      }
<span class="nc bnc" id="L158" title="All 2 branches missed.">      if (!file.isFile()) {</span>
<span class="nc" id="L159">        throw new IllegalStateException(&quot;Artifact is not fully assembled: &quot; + file);</span>
      }

<span class="nc bnc" id="L162" title="All 2 branches missed.">      if (installedArtifacts.add(artifact.getId())) {</span>
<span class="nc" id="L163">        artifact.setFile(file);</span>
<span class="nc" id="L164">        installer.install(projectBuildingRequest, itfRepository,</span>
<span class="nc" id="L165">            Collections.singletonList(artifact));</span>
      } else {
<span class="nc" id="L167">        getLog().debug(&quot;Not re-installing &quot; + artifact + &quot;, &quot; + file);</span>
      }
<span class="nc" id="L169">    } catch (Exception e) {</span>
<span class="nc" id="L170">      throw new MojoExecutionException(&quot;Failed to install artifact: &quot; + artifact, e);</span>
<span class="nc" id="L171">    }</span>
<span class="nc" id="L172">  }</span>

  /**
   * Installs the specified artifact to the local repository. This method serves basically the same purpose as
   * {@link #installArtifact(File, Artifact)} but is meant for artifacts that have been resolved
   * from the user's local repository (and not the current build outputs). The subtle difference here is that
   * artifacts from the repository have already undergone transformations and these manipulations should not be redone
   * by the artifact installer. For this reason, this method performs plain copy operations to install the artifacts.
   *
   * @param file The file associated with the artifact, must not be &lt;code&gt;null&lt;/code&gt;.
   * @param artifact The artifact to install, must not be &lt;code&gt;null&lt;/code&gt;.
   * @throws MojoExecutionException If the artifact could not be installed (e.g. has no associated file).
   */
  private void copyArtifact(File file, Artifact artifact)
      throws MojoExecutionException {
    try {
<span class="nc bnc" id="L188" title="All 2 branches missed.">      if (file == null) {</span>
<span class="nc" id="L189">        throw new IllegalStateException(&quot;Artifact has no associated file: &quot; + artifact.getId());</span>
      }
<span class="nc bnc" id="L191" title="All 2 branches missed.">      if (!file.isFile()) {</span>
<span class="nc" id="L192">        throw new IllegalStateException(&quot;Artifact is not fully assembled: &quot; + file);</span>
      }

<span class="nc bnc" id="L195" title="All 2 branches missed.">      if (copiedArtifacts.add(artifact.getId())) {</span>
<span class="nc" id="L196">        File destination =</span>
            new File(itfRepository,
<span class="nc" id="L198">                repositoryManager.getPathForLocalArtifact(projectBuildingRequest, artifact));</span>

<span class="nc" id="L200">        getLog().debug(&quot;Installing &quot; + file + &quot; to &quot; + destination);</span>

<span class="nc" id="L202">        copyFileIfDifferent(file, destination);</span>

<span class="nc" id="L204">        MetadataUtils.createMetadata(destination, artifact);</span>
<span class="nc" id="L205">      } else {</span>
<span class="nc" id="L206">        getLog().debug(&quot;Not re-installing &quot; + artifact + &quot;, &quot; + file);</span>
      }
<span class="nc" id="L208">    } catch (Exception e) {</span>
<span class="nc" id="L209">      throw new MojoExecutionException(&quot;Failed to stage artifact: &quot; + artifact, e);</span>
<span class="nc" id="L210">    }</span>
<span class="nc" id="L211">  }</span>

  private void copyFileIfDifferent(File src, File dst)
      throws IOException {
<span class="nc bnc" id="L215" title="All 4 branches missed.">    if (src.lastModified() != dst.lastModified() || src.length() != dst.length()) {</span>
<span class="nc" id="L216">      FileUtils.copyFile(src, dst);</span>
<span class="nc" id="L217">      dst.setLastModified(src.lastModified());</span>
    }
<span class="nc" id="L219">  }</span>

  /**
   * Installs the main artifact and any attached artifacts of the specified project to the local repository.
   *
   * @param mvnProject The project whose artifacts should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
   * @throws MojoExecutionException If any artifact could not be installed.
   */
  private void installProjectArtifacts(MavenProject mvnProject)
      throws MojoExecutionException {
    try {
      // Install POM (usually attached as metadata but that happens only as a side effect of the Install Plugin)
<span class="nc" id="L231">      installProjectPom(mvnProject);</span>

      // Install the main project artifact (if the project has one, e.g. has no &quot;pom&quot; packaging)
<span class="nc" id="L234">      Artifact mainArtifact = mvnProject.getArtifact();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">      if (mainArtifact.getFile() != null) {</span>
<span class="nc" id="L236">        installArtifact(mainArtifact.getFile(), mainArtifact);</span>
      }

      // Install any attached project artifacts
<span class="nc" id="L240">      Collection&lt;Artifact&gt; attachedArtifacts = mvnProject.getAttachedArtifacts();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">      for (Artifact attachedArtifact : attachedArtifacts) {</span>
<span class="nc" id="L242">        installArtifact(attachedArtifact.getFile(), attachedArtifact);</span>
<span class="nc" id="L243">      }</span>
<span class="nc" id="L244">    } catch (Exception e) {</span>
<span class="nc" id="L245">      throw new MojoExecutionException(&quot;Failed to install project artifacts: &quot; + mvnProject, e);</span>
<span class="nc" id="L246">    }</span>
<span class="nc" id="L247">  }</span>

  /**
   * Installs the (locally reachable) parent POMs of the specified project to the local repository. The parent POMs
   * from the reactor must be installed or the forked IT builds will fail when using a clean repository.
   *
   * @param mvnProject The project whose parent POMs should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
   * @throws MojoExecutionException If any POM could not be installed.
   */
  private void installProjectParents(MavenProject mvnProject)
      throws MojoExecutionException {
    try {
<span class="nc bnc" id="L259" title="All 2 branches missed.">      for (MavenProject parent = mvnProject.getParent(); parent != null; parent = parent.getParent()) {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (parent.getFile() == null) {</span>
<span class="nc" id="L261">          copyParentPoms(parent.getGroupId(), parent.getArtifactId(), parent.getVersion());</span>
<span class="nc" id="L262">          break;</span>
        }
<span class="nc" id="L264">        installProjectPom(parent);</span>
      }
<span class="nc" id="L266">    } catch (Exception e) {</span>
<span class="nc" id="L267">      throw new MojoExecutionException(&quot;Failed to install project parents: &quot; + mvnProject, e);</span>
<span class="nc" id="L268">    }</span>
<span class="nc" id="L269">  }</span>

  /**
   * Installs the POM of the specified project to the local repository.
   *
   * @param mvnProject The project whose POM should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
   * @throws MojoExecutionException If the POM could not be installed.
   */
  private void installProjectPom(MavenProject mvnProject)
      throws MojoExecutionException {
    try {
<span class="nc" id="L280">      Artifact pomArtifact = null;</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">      if (&quot;pom&quot;.equals(mvnProject.getPackaging())) {</span>
<span class="nc" id="L282">        pomArtifact = mvnProject.getArtifact();</span>
      }
<span class="nc bnc" id="L284" title="All 2 branches missed.">      if (pomArtifact == null) {</span>
<span class="nc" id="L285">        pomArtifact =</span>
<span class="nc" id="L286">            artifactFactory.createProjectArtifact(mvnProject.getGroupId(), mvnProject.getArtifactId(),</span>
<span class="nc" id="L287">                mvnProject.getVersion());</span>
      }
<span class="nc" id="L289">      installArtifact(mvnProject.getFile(), pomArtifact);</span>
<span class="nc" id="L290">    } catch (Exception e) {</span>
<span class="nc" id="L291">      throw new MojoExecutionException(&quot;Failed to install POM: &quot; + mvnProject, e);</span>
<span class="nc" id="L292">    }</span>
<span class="nc" id="L293">  }</span>

<span class="nc" id="L295">  private static final Function&lt;Artifact, String&gt; ArtifactIntoGAV = artifact -&gt; artifact.getGroupId() + ':' + artifact.getArtifactId() + ':' + artifact.getBaseVersion();</span>
<span class="nc" id="L296">  private static final Function&lt;MavenProject, String&gt; ProjectIntoGAV = project -&gt; project.getGroupId() + ':' + project.getArtifactId() + ':' + project.getVersion();</span>

  private static final Predicate&lt;Artifact&gt; isInProjects(Map&lt;String, MavenProject&gt; projects) {
<span class="nc" id="L299">    return s -&gt; projects.containsKey(ArtifactIntoGAV.apply(s));</span>
  }

  /**
   * Installs the dependent projects from the reactor to the local repository. The dependencies on other modules from
   * the reactor must be installed or the forked IT builds will fail when using a clean repository.
   *
   * @param mvnProject The project whose dependent projects should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
   * @param reactorProjects The set of projects in the reactor build, must not be &lt;code&gt;null&lt;/code&gt;.
   * @throws MojoExecutionException If any dependency could not be installed.
   */
  private void installProjectDependencies(MavenProject mvnProject, Collection&lt;MavenProject&gt; reactorProjects)
      throws MojoExecutionException {

    // ... into dependencies that were resolved from reactor projects ...
<span class="nc" id="L314">    Collection&lt;String&gt; dependencyProjects = new LinkedHashSet&lt;&gt;();</span>
<span class="nc" id="L315">    collectAllProjectReferences(mvnProject, dependencyProjects);</span>

    // index available reactor projects
<span class="nc" id="L318">    Map&lt;String, MavenProject&gt; projects = reactorProjects.stream()</span>
<span class="nc" id="L319">        .collect(Collectors.toMap(ProjectIntoGAV, identity()));</span>

    // group transitive dependencies (even those that don't contribute to the class path like POMs) ...
    // ... and those that were resolved from the (local) repo
<span class="nc" id="L323">    Collection&lt;Artifact&gt; dependencyArtifacts = mvnProject.getArtifacts().stream()</span>
<span class="nc" id="L324">        .filter(isInProjects(projects).negate())</span>
<span class="nc" id="L325">        .collect(Collectors.collectingAndThen(Collectors.toList(), LinkedHashSet::new));</span>

    // install dependencies
    try {
      // copy dependencies that where resolved from the local repo
<span class="nc bnc" id="L330" title="All 2 branches missed.">      for (Artifact artifact : dependencyArtifacts) {</span>
<span class="nc" id="L331">        copyArtifact(artifact);</span>
<span class="nc" id="L332">      }</span>

      // install dependencies that were resolved from the reactor
<span class="nc bnc" id="L335" title="All 2 branches missed.">      for (String projectId : dependencyProjects) {</span>
<span class="nc" id="L336">        MavenProject dependencyProject = projects.get(projectId);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (dependencyProject == null) {</span>
<span class="nc" id="L338">          getLog().warn(&quot;skip dependencyProject null for projectId=&quot; + projectId);</span>
<span class="nc" id="L339">          continue;</span>
        }
<span class="nc" id="L341">        getLog().info(&quot; *-&gt; &quot; + project.getId());</span>
<span class="nc" id="L342">        installProjectArtifacts(dependencyProject);</span>
<span class="nc" id="L343">        installProjectParents(dependencyProject);</span>
<span class="nc" id="L344">      }</span>
<span class="nc" id="L345">    } catch (Exception e) {</span>
<span class="nc" id="L346">      throw new MojoExecutionException(&quot;Failed to install project dependencies: &quot; + mvnProject, e);</span>
<span class="nc" id="L347">    }</span>
<span class="nc" id="L348">  }</span>

  protected void collectAllProjectReferences(MavenProject project, Collection&lt;String&gt; dependencyProjects) {
<span class="nc bnc" id="L351" title="All 2 branches missed.">    for (MavenProject reactorProject : project.getProjectReferences().values()) {</span>
<span class="nc" id="L352">      String projectId =</span>
<span class="nc" id="L353">          reactorProject.getGroupId() + ':' + reactorProject.getArtifactId() + ':' + reactorProject.getVersion();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">      if (dependencyProjects.add(projectId)) {</span>
<span class="nc" id="L355">        collectAllProjectReferences(reactorProject, dependencyProjects);</span>
      }
<span class="nc" id="L357">    }</span>
<span class="nc" id="L358">  }</span>

  private void copyArtifact(Artifact artifact)
      throws MojoExecutionException {
<span class="nc" id="L362">    copyPoms(artifact);</span>

<span class="nc" id="L364">    Artifact depArtifact =</span>
<span class="nc" id="L365">        artifactFactory.createArtifactWithClassifier(artifact.getGroupId(), artifact.getArtifactId(),</span>
<span class="nc" id="L366">            artifact.getBaseVersion(), artifact.getType(),</span>
<span class="nc" id="L367">            artifact.getClassifier());</span>

<span class="nc" id="L369">    File artifactFile = artifact.getFile();</span>

<span class="nc" id="L371">    copyArtifact(artifactFile, depArtifact);</span>
<span class="nc" id="L372">  }</span>

  private void copyPoms(Artifact artifact)
      throws MojoExecutionException {
<span class="nc" id="L376">    Artifact pomArtifact =</span>
<span class="nc" id="L377">        artifactFactory.createProjectArtifact(artifact.getGroupId(), artifact.getArtifactId(),</span>
<span class="nc" id="L378">            artifact.getBaseVersion());</span>

<span class="nc" id="L380">    File pomFile = new File(localRepository.getBasedir(), localRepository.pathOf(pomArtifact));</span>

<span class="nc bnc" id="L382" title="All 2 branches missed.">    if (pomFile.isFile()) {</span>
<span class="nc" id="L383">      copyArtifact(pomFile, pomArtifact);</span>
<span class="nc" id="L384">      copyParentPoms(pomFile);</span>
    }
<span class="nc" id="L386">  }</span>

  /**
   * Installs all parent POMs of the specified POM file that are available in the local repository.
   *
   * @param pomFile The path to the POM file whose parents should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
   * @throws MojoExecutionException If any (existing) parent POM could not be installed.
   */
  private void copyParentPoms(File pomFile)
      throws MojoExecutionException {
<span class="nc" id="L396">    Model model = ProjectHelper.readProject(pomFile.toPath());</span>
<span class="nc" id="L397">    Parent parent = model.getParent();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">    if (parent != null) {</span>
<span class="nc" id="L399">      copyParentPoms(parent.getGroupId(), parent.getArtifactId(), parent.getVersion());</span>
    }
<span class="nc" id="L401">  }</span>

  /**
   * Installs the specified POM and all its parent POMs to the local repository.
   *
   * @param groupId The group id of the POM which should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
   * @param artifactId The artifact id of the POM which should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
   * @param version The version of the POM which should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
   * @throws MojoExecutionException If any (existing) parent POM could not be installed.
   */
  private void copyParentPoms(String groupId, String artifactId, String version)
      throws MojoExecutionException {
<span class="nc" id="L413">    Artifact pomArtifact = artifactFactory.createProjectArtifact(groupId, artifactId, version);</span>

<span class="nc bnc" id="L415" title="All 4 branches missed.">    if (installedArtifacts.contains(pomArtifact.getId()) || copiedArtifacts.contains(pomArtifact.getId())) {</span>
<span class="nc" id="L416">      getLog().debug(&quot;Not re-installing &quot; + pomArtifact);</span>
<span class="nc" id="L417">      return;</span>
    }

<span class="nc" id="L420">    File pomFile = new File(localRepository.getBasedir(), localRepository.pathOf(pomArtifact));</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">    if (pomFile.isFile()) {</span>
<span class="nc" id="L422">      copyArtifact(pomFile, pomArtifact);</span>
<span class="nc" id="L423">      copyParentPoms(pomFile);</span>
    }
<span class="nc" id="L425">  }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>